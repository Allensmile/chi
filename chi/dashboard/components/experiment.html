<!DOCTYPE html>
<html>
<head>
  <!-- <base href="/"> -->
  <title>chiboard</title>
  <link href="/bower_components/polymer/polymer.html" rel="import">
  <link href="/bower_components/iron-ajax/iron-ajax.html" rel="import" >
  <link href="/bower_components/paper-toolbar/paper-toolbar.html" rel="import" >
  <link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
  <link href="/bower_components/paper-button/paper-button.html" rel="import" >
  <link href="/bower_components/paper-card/paper-card.html" rel="import" >
  <link href="/bower_components/app-route/app-route.html" rel="import" >
  <link rel="import" href="/bower_components/iron-icons/iron-icons.html">
  <script src="/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="/bower_components/jquery/jquery.min.js"></script>

  <link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
  <link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">

  <!-- <link rel="import" href="/bower_components/paper-tabs//paper-tab.html"> -->
  <link rel="import" href="/bower_components/iron-pages/iron-pages.html">


  <style>
  html, body{
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }

</style>
</head>

<body>

<experiment-page> </experiment-page>

<dom-module id="experiment-page">
  <style type="text/css">
    :host{
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: content-box;
    };

    .toolb{
      --paper-toolbar-height: 50px;
      z-index: 10005;
      box-shadow: 0 0 4px rgba(0,0,0,.15), 0 4px 8px rgba(0,0,0,.30);
    };

    .font{
      font-size: 30px;
      font-weight: normal;
      text-decoration: none;
      text-shadow: -.1px -.1px rgba(0,0,0,.1);
      font: Roboto,sans-serif;
      font-style: normal;
      font-variant-ligatures: normal;
      font-variant-caps: normal;
      font-variant-numeric: normal;
      font-weight: 400;
      font-stretch: normal;
      font-size: 30px;
      font-family: Roboto, sans-serif;
      color: white;

  	};

    paper-tabs{
    	margin-left: 30px;
    };

    iframe{
          height: 100%;
          width: 100%;
          margin-top: -10px;
          padding: 0;
    };

    .log-page{
			margin: 0;
			height: 100%;
			width: 100%;
			padding: 5px;
			box-sizing: border-box;
			display: flex;
			background-color: darkgrey;
			flex-flow: column wrap;

			flex-flow: center;
			overflow: auto;

    };
    iron-pages{
         height: 100%;
          width: 100%;
                      margin: 0;
          padding: 0;
    }

    .page{
         height: 100%;
          width: 100%;
                      margin: 0;
          padding: 0;
          overflow: auto;
    };

    #details{
    	  		font-family: "Lucida Console", Monaco, monospace;
		color: black;
		width: 100%;
		height: 100%;
		overflow: auto;
		box-sizing: border-box;
		padding: 15px;
    }

  </style>

  <template>
  <paper-header-panel>
    <paper-toolbar class="toolb">
      <!--<paper-icon-button icon="menu" on-tap="menuAction"></paper-icon-button>-->
      <div class="font"><a class="font" href="/">chiboard</a></div>

      <paper-tabs selected="{{selected}}">
			  <paper-tab>Logs</paper-tab>
			  <paper-tab>Details</paper-tab>
			  <paper-tab>TensorBoard</paper-tab>
			</paper-tabs>

    </paper-toolbar>

    <iron-pages class="" selected="{{selected}}">
		  <div class="log-page">
        <template is="dom-repeat" items="[[logs]]">
          <log-view data=[[item]]></log-view>
	  		</template>
	  	</div>

    	<div class="page">
    		<pre id="details" class=""></pre>
    	</div>

		  <div class="page">
				<!-- <div style="height:40px"></div> -->
		  	<iframe name="dudu" id="myiframe" src=""></iframe>
		  </div>
		</iron-pages>

	</paper-header-panel>
  </template>

  <script>
	Polymer({
    is: 'experiment-page',

    properties: {
	    selected: {
	        value: 0
	    },

	    logs: Array,

    },

    ready: function(){

    	// details
      var req_details = function(){
      	loc = window.location.hash.split('/')
      	// host = loc[1] == 'local' ? window.location.host : loc[1]
      	host = window.location.host
        url = 'http://' + host + '/info/' + loc.slice(1).join('/')   
      	console.log('details url: ' + url)

        $.getJSON(url, data => {
          console.log('got details')
          document.title = data.name
          this.details.innerHTML = JSON.stringify(data, undefined, 2);
        })
 			}

      req_details()
      setInterval(req_details, 2000)


      // tensorboard

      var frame = this.$.myiframe
      frame._empty = true

      // $('#myiframe').on('load', ()=>{
      //   console.log('onload')
      //   frame._is_active=true
      // })

      var req_tb = function(){ 
        url = '/tb/' + window.location.hash.split('/').slice(1).join('/')   
        $.getJSON(url, data => {
          console.log('got data')
          src = 'http://'+data.host+':'+data.port
          if(frame._empty || data.new){
            frame.src = src
            frame._empty = false
          }
      	});
      }

      req_tb()
      setInterval(req_tb, 5000);


      // logs
      var self = this
      var req_logs = function(){
      	loc = window.location.hash.split('/')
      	host = loc[1] == 'local' ? window.location.host : loc[1]
        url = 'http://' + host + '/logs/' + loc.slice(2).join('/')   
      	console.log('logs url: ' + url)

        $.getJSON(url, data => {
          console.log('got logs ' + data.length)

          self.logs = data
        })
 			}

      req_logs()
      setInterval(req_logs, 2000)


    }

  });
  </script>
</dom-module>

<dom-module id="log-view">
<style type="text/css">
	:host{
    flex: 1;
    min-width: 500px;
    /*max-width: 800px;*/
    min-height: 300px;
    /*max-height: 800px;*/
    overflow: hidden;
    box-shadow: 0 0 4px rgba(0,0,0,.15), 0 4px 8px rgba(0,0,0,.30);
    margin: 5px;

		background-color: black;

	};

	paper-toolbar{
    --paper-toolbar-background: #01A35E;
    --paper-toolbar-height: 30px;
	};


	#log{
		font-family: "Lucida Console", Monaco, monospace;
		color: lightgrey;
		width: 100%;
		height: 100%;
		overflow: auto;
		box-sizing: border-box;
		padding: 15px;

	};

</style>

<template>
	<paper-header-panel mode="seamed">
	  <paper-toolbar>
	  	<div id="title" class="title"></div>
  	</paper-toolbar>
	 <div id="log"><pre id="content"></pre></div>
  </paper-header-panel>
</template>

<script type="text/javascript">

Polymer({
  is: 'log-view',

  properties: {
    data: {
    	type: Object,
      notify: true
    },

  },

  ready: function(){
 		var log = this.$.log
 		this.$.log._should_scroll = true
 		log.onscroll = ()=>{
 			this.$.log._should_scroll = log.scrollHeight-log.scrollTop == log.clientHeight
 			console.log(this.$.log._should_scroll)
 		}
  	this.addEventListener("data-changed", ()=>{
			console.log('data-changed')
  		this.$.title.innerHTML = this.data.name
  		this.$.content.innerHTML = this.data.content
  		if(this.$.log._should_scroll){
  			console.log('scroll')
	      Polymer.RenderStatus.afterNextRender(this, () => {
    			log.scrollTop = log.scrollHeight;
    		})
  		}

  	})

  },

});
</script>
</dom-module>


</body>
</html>


